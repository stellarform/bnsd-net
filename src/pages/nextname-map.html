<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Athlete Database</title>
  <!-- Google Fonts for Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <style>
    /* Ensure elements don't overhang the screen */
    * {
      box-sizing: border-box;
    }
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }
    body {
      background-color: #5c5c5c;
      color: white;
      font-family: 'Roboto', sans-serif;
      text-align: center;
      margin: 0;
      padding-top: 40px;
      padding-bottom: 40px;
    }
    /* Title styling */
    h1 {
      margin: 5px 0;
      margin-bottom: 32px;
    }
    /* Map container styling */
    .map-container {
      position: relative;
      width: 95%;
      margin: 20px auto;
      background-color: #444;
      border-radius: 10px;
      overflow: hidden;
      max-width: 1425px;
    }
    /* Integrated button bar styling */
    .map-button-bar {
      background-color: #444;
      padding: 10px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #555;
    }
    /* Grouping the left and right controls */
    .button-group {
      display: flex;
      gap: 10px;
    }
    .button-group.right {
      margin-left: auto;
    }
    /* Style for controls to match the isolate buttons */
    .map-button {
      background-color: #2b2b2b;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 9pt;
      font-weight: 300;
      font-family: Roboto;
    }
    .map-button:hover {
      background-color: #777;
    }
    svg {
      width: 100%;
      height: auto;
      display: block;
    }
    .map {
      fill: black;
      stroke: #444;
      stroke-width: 0.5;
    }
    .line {
      fill: none;
      stroke: rgb(255, 255, 255);
      stroke-width: 2;
      stroke-linecap: round;
    }
    .dot {
      fill: rgb(255, 255, 255);
      stroke: rgb(255, 255, 255);
      stroke-width: 1;
    }
    /* Loading bar overlay styles */
    #loadingBar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #loadingProgress {
      width: 300px;
      height: 20px;
      background: #555;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    #loadingProgress::after {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0%;
      background: #969696;
      animation: loading 1.5s ease-in-out infinite;
    }
    @keyframes loading {
      0% { width: 0%; }
      50% { width: 100%; }
      100% { width: 0%; }
    }
    /* Table container with side padding */
    .table-container {
      width: 100%;
      overflow-x: auto;
      margin: 20px auto;
      padding: 0 0px;
      max-width: 1500px;
    }
    /* Modern table styling */
    table {
      width: 95%;
      margin: 0 auto;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 10px;
      overflow: hidden;
      background-color: #444;
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #555;
      border-right: 1px solid #555;
    }
    th:last-child, td:last-child {
      border-right: none;
    }
    /* Table header styling (desktop) */
    thead th {
      background-color: #2b2b2b;
      color: white;
      font-size: 11pt;
      font-weight: 500;
      cursor: pointer;
      padding: 12px 16px;
      position: relative;
    }
    /* Isolate header styling */
    th.isolate-header {
      background-color: #2b2b2b;
      border: none;
      padding: 0;
      border-right: 1px solid #555;
      border-bottom: 1px solid #555;
    }
    td {
      font-size: 10pt;
      font-weight: 300;
    }
    th::after {
      content: "";
    }
    th.asc::after {
      content: " ↑";
      font-size: 16px;
      margin-left: 5px;
    }
    th.desc::after {
      content: " ↓";
      font-size: 16px;
      margin-left: 5px;
    }
    /* Dropdown menu styling */
    .sort-menu {
      display: none;
      position: absolute;
      background-color: #2b2b2b;
      padding: 8px 0;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
      max-height: 500px;
      overflow-y: auto;
    }
    .sort-menu button {
      font-family: 'Roboto', sans-serif;
      font-size: 11pt;
      text-align: left;
      width: 100%;
      padding: 10px;
      background-color: transparent;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .sort-menu button:hover,
    .sort-menu button.active {
      background-color: #333;
    }
    .sort-menu hr {
      border: 0;
      border-top: 1px solid #555;
      margin: 5px 0;
    }
    .filter-title {
      display: block;
      text-align: left;
      padding: 0 10px;
      font-size: 12pt;
      border-bottom: 0px solid #555;
      margin-bottom: 5px;
    }
    /* Isolate column and button styling */
    th.isolate-header,
    td.isolate-cell {
      width: 60px;
      text-align: center;
    }
    .isolate-button {
      background-color: #2b2b2b;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      color: #969696;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 9pt;
      font-weight: 300;
      font-family: Roboto;
    }
    .isolate-button:hover {
      background-color: #777;
    }
    .isolate-button.selected {
      background-color: #969696;
    }
    /* Reset Sorting button styling */
    #resetSortingButton {
      background-color: #2b2b2b;
    }
    /* Active sort header styling */
    th.active-sort {
      background-color: #333;
    }
    /* Mobile styles */
    @media (max-width: 600px) {
      h1 { font-size: 22pt; }
      h2 { font-size: 18pt; }
      h3 { font-size: 16pt; }
      h4 { font-size: 14pt; }
      h5 { font-size: 12pt; }
      h6 { font-size: 10pt; }
      thead th { font-size: 9pt; padding: 8px 10px; }
      td { font-size: 8pt; padding: 8px 10px; }
      .filter-title { font-size: 9pt; }
      button, .sort-menu button, .animation-button, .isolate-button {
        font-size: 8pt;
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Combined SVG placed at the very top with increased size and white fill -->
  <svg id="Layer_1" style="height: 1.25em; vertical-align: middle; display: block; margin: 0 auto 5px auto;" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 99.9 12.44">
    <path fill="white" d="
      M8.49 8.42 L2.31 0 L0 0 L0 12.42 L2.37 12.42 L2.37 3.97 L8.55 12.42 L10.86 12.42 L10.86 0 L8.49 0 Z
      M12.53 12.42 L21.95 12.42 L21.95 10.1 L14.9 10.1 L14.9 7.37 L21.2 7.37 L21.2 5.03 L14.9 5.03 L14.9 2.32 L21.95 2.32 L21.95 0 L12.53 0 Z
      M37.7 2.3 L41.65 2.3 L41.65 12.42 L44.02 12.42 L44.02 2.3 L47.97 2.3 L47.97 0 L37.7 0 Z
      M58.15 8.42 L51.97 0 L49.66 0 L49.66 12.42 L52.02 12.42 L52.03 3.97 L58.21 12.42 L60.51 12.42 L60.52 0 L58.15 0 Z
      M67.46 0 l-5.27 12.41 h2.6 s1.39-3.29 1.39-3.29 h4.89 s1.39 3.29 1.39 3.29 h2.6 S69.79 0 69.79 0 h-2.33 Z
      M67.13 6.86 l1.5-3.58 1.5 3.58 h-2.99 Z
      M82.77 5.01 L78.99 0 L76.69 0 L76.68 12.42 L79.05 12.42 L79.05 4.05 L82.78 8.77 L86.42 4.08 L86.42 12.42 L88.79 12.42 L88.79 0 L86.49 0 L82.77 5.01 Z
      M99.89 2.32 L99.9 0 L90.48 0 L90.47 12.42 L99.89 12.42 L99.89 10.1 L92.84 10.1 L92.84 7.37 L99.14 7.37 L99.14 5.03 L92.84 5.03 L92.84 2.32 L99.89 2.32 Z
      M25.17 0.94 h1.11 
        l3.26 4.32 
        l0.3 0.39 
        l0.3 -0.4 
        l3.26 -4.32 
        h1.14 
        l-3.89 5.05 
        l-0.18 0.23 
        l0.18 0.23 
        l3.89 5.07 
        h-1.1 
        l-3.31 -4.36 
        l-0.3 -0.39 
        l-0.3 0.4 
        l-3.27 4.36 
        h-1.1 
        l3.9 -5.06 
        l0.18 -0.23 
        l-0.18 -0.23 
        l-3.9 -5.06
      M23.29 0 
        l4.79 6.22 
        l-4.79 6.22 
        h3.4 
        s3.14 -4.16 3.14 -4.16 
        l3.15 4.17 
        h3.4 
        s-4.79 -6.22 -4.79 -6.22 
        L36.37 0 
        h-3.4 
        s-3.14 4.16 -3.14 4.16 
        L26.69 0 
        h-3.4 Z
    "/>
  </svg>
  
  <!-- Title -->
  <h1>Athlete Database</h1>
  
  <div class="map-container">
    <!-- Integrated Button Bar -->
    <div class="map-button-bar">
      <div class="button-group left">
        <button id="zoomIn" class="map-button">+</button>
        <button id="zoomOut" class="map-button">-</button>
        <button id="resetZoom" class="map-button">Reset Zoom</button>
      </div>
      <div class="button-group right">
        <button id="animationControlButton" class="map-button">Animation: On</button>
        <button id="resetButton" class="map-button">Reset</button>
      </div>
    </div>
    <!-- Map SVG -->
    <svg id="map" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet"></svg>
    <!-- Loading animation bar overlay -->
    <div id="loadingBar">
      <div id="loadingProgress"></div>
    </div>
  </div>
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <!-- Leftmost header cell: Reset Sorting button -->
          <th class="isolate-header">
            <button id="resetSortingButton" class="isolate-button">Reset</button>
          </th>
          <th id="nameHeader">
            Athlete Name
            <div class="sort-menu">
              <button onclick="sortTableButton('name', 'asc', this)">Sort by Name Ascending</button>
              <button onclick="sortTableButton('name', 'desc', this)">Sort by Name Descending</button>
            </div>
          </th>
          <th id="hometownHeader">
            Hometown
            <div class="sort-menu">
              <span class="filter-title">Filter by State:</span>
              <div id="hometownStateButtons"></div>
            </div>
          </th>
          <th id="schoolHeader">
            School
            <div class="sort-menu">
              <span class="filter-title">Filter by State:</span>
              <div id="schoolStateButtons"></div>
            </div>
          </th>
          <th id="sportHeader">
            Sport
            <div class="sort-menu">
              <button onclick="filterTableBySport('All', this)">All</button>
              <button onclick="filterTableBySport('Football', this)">Football</button>
              <button onclick="filterTableBySport('Baseball', this)">Baseball</button>
              <button onclick="filterTableBySport('Basketball', this)">Basketball</button>
              <button onclick="filterTableBySport('Golf', this)">Golf</button>
              <button onclick="filterTableBySport('Swimming & Diving', this)">Swimming & Diving</button>
              <button onclick="filterTableBySport('Track & Field', this)">Track & Field</button>
              <button onclick="filterTableBySport('Volleyball', this)">Volleyball</button>
            </div>
          </th>
        </tr>
      </thead>
      <tbody id="athleteTable"></tbody>
    </table>
  </div>
  
  <script>
    // Global animation flag.
    let animationEnabled = true;
    let loadingBarHidden = false;
    let currentSchoolStateFilters = [];
    let currentHometownStateFilters = [];
    
    // Coordinate cache.
    const coordinateCache = {};
    async function getCoordinatesCached(city) {
      if (coordinateCache[city]) return coordinateCache[city];
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
      const data = await response.json();
      const coords = data.length ? [parseFloat(data[0].lon), parseFloat(data[0].lat)] : null;
      coordinateCache[city] = coords;
      return coords;
    }
    async function getCoordinates(city) {
      return await getCoordinatesCached(city);
    }
    
    // Dropdown management.
    let currentDropdown = null;
    let currentDropdownParent = null;
    function showDropdown(th) {
      const menu = th.querySelector(".sort-menu");
      if (!menu) return;
      currentDropdown = menu;
      currentDropdownParent = th;
      // Compute the absolute coordinates relative to the document.
      const rect = th.getBoundingClientRect();
      menu.style.position = "absolute";
      menu.style.top = (rect.bottom + window.scrollY) + "px";
      menu.style.left = (rect.left + window.scrollX) + "px";
      menu.style.width = rect.width + "px";
      menu.style.display = "block";
      document.body.appendChild(menu);
    }
    function hideDropdown() {
      if (currentDropdown && currentDropdownParent) {
        currentDropdown.style.display = "none";
        currentDropdownParent.appendChild(currentDropdown);
      }
      currentDropdown = null;
      currentDropdownParent = null;
    }
    
    // Create a main group for all map elements.
    const width = 1000, height = 600;
    const svg = d3.select("#map");
    const gAll = svg.append("g");
    
    const projection = d3.geoAlbersUsa().translate([width/2, height/2]).scale(1200);
    const path = d3.geoPath().projection(projection);
    d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
      gAll.append("g")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.states).features)
        .enter()
        .append("path")
        .attr("class", "map")
        .attr("d", path);
    });
    
    // Global athlete list.
    const athletes = [
        { name: "Coleman Hawkins", hometown: "Sacramento, CA", school: "Manhattan, KS", sport: "Basketball" },
        { name: "Luke Goode", hometown: "Fort Wayne, IN", school: "Bloomington, IN", sport: "Basketball" },
        { name: "Ty Rodgers", hometown: "Saginaw, MI", school: "Champaign, IL", sport: "Basketball" },
        { name: "Maya Imoto-Eakin", hometown: "Honolulu, HI", school: "Hilo, HI", sport: "Volleyball" },
        { name: "Sencire Harris", hometown: "North Canton, OH", school: "Morgantown, WV", sport: "Basketball" },
        { name: "Dain Dainja", hometown: "Brooklyn Park, MN", school: "Memphis, TN", sport: "Basketball" },
        { name: "Robert Castillo", hometown: "Glendora, CA", school: "Huntington Beach, CA", sport: "Baseball" },
        { name: "Myah Hazelton", hometown: "Baltimore, MD", school: "Blacksburg, VA", sport: "Basketball" },
        { name: "Clay Shelton", hometown: "Williamsburg, KY", school: "Williamsburg, KY", sport: "Baseball" },
        { name: "Merik Carter", hometown: "Shelbyville, TN", school: "Boiling Springs, NC", sport: "Baseball" },
        { name: "Lily Barry", hometown: "Emden, IL", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Brooke Mosher", hometown: "Waterloo, WI", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Kayla Burbage", hometown: "Clayton, NC", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Lani White", hometown: "Irvine, CA", school: "Blacksburg, VA", sport: "Basketball" },
        { name: "Cooper Donlin", hometown: "Plymouth, MI", school: "Honolulu, HI", sport: "Baseball" },
        { name: "Jackson Buchanan", hometown: "Dacula, GA", school: "Champaign, IL", sport: "Golf" },
        { name: "Alex Rodriguez", hometown: "Bourbonnais, IL", school: "Edwardsville, IL", sport: "Baseball" },
        { name: "Kylee Sessions", hometown: "Leesburg, VA", school: "Champaign, IL", sport: "Swimming & Diving" },
        { name: "Peyton Fitzherbert", hometown: "Palm City, FL", school: "Lakeland, FL", sport: "Soccer" },
        { name: "Sophie Stephenson", hometown: "Seattle, WA", school: "Los Angeles, CA", sport: "Volleyball" },
        { name: "Matt Haley", hometown: "Fenton, MO", school: "Springfield, MO", sport: "Baseball" },
        { name: "Dante Zamudio", hometown: "Sylmar, CA", school: "Northridge, CA", sport: "Baseball" },
        { name: "Will Semb", hometown: "De Pere, WI", school: "Minneapolis, MN", sport: "Baseball" },
        { name: "Caroline Barnes", hometown: "Naperville, IL", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Bianca May", hometown: "Orland Park, IL", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Gabby Dean", hometown: "Columbus, IN", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Bryson \"Cecil\" Lofton", hometown: "Dalton, GA", school: "Carbondale, IL", sport: "Baseball" },
        { name: "Dante Thompson", hometown: "Montgomery Village, MD", school: "Arlington Heights, IL", sport: "Football" },
        { name: "Sarah Bingham", hometown: "Fairway, KS", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Cari Bohm", hometown: "Ann Arbor, MI", school: "Champaign, IL", sport: "Volleyball" },
        { name: "Anna Ritter", hometown: "New Albany, OH", school: "Champaign, IL", sport: "Golf" },
        { name: "Bryce Barnes", hometown: "Gaithersburg, MD", school: "Williamsburg, VA", sport: "Football" },
        { name: "Ryan Voois", hometown: "Ladera Ranch, CA", school: "Champaign, IL", sport: "Golf" },
        { name: "Easton Moore", hometown: "Zionsville, IN", school: "Rock Hill, SC", sport: "Baseball" },
        { name: "Coby Rogers", hometown: "Fenton, MO", school: "Emporia, KS", sport: "Baseball" },
        { name: "Sebastian Gonzalez", hometown: "Oakley, CA", school: "Honolulu, HI", sport: "Baseball" },
        { name: "Quincy Thornton", hometown: "Morgantown, WV", school: "Martin, TN", sport: "Baseball" },
        { name: "Reece Ihenacho", hometown: "Fox River Grove, IL", school: "Champaign, IL", sport: "Track & Field" },
        { name: "Nate Dorinsky", hometown: "Columbus, OH", school: "Greensburg, PA", sport: "Baseball" },
        { name: "Taylor Lauterbach", hometown: "Appleton, WI", school: "Charlottesville, VA", sport: "Basketball" },
        { name: "Olivia McGhee", hometown: "Louisa, VA", school: "Charlottesville, VA", sport: "Basketball" },

    ];
    
    let currentSportFilter = "All";
    let currentSort = {};
    
    // Helper: extract state.
    function getState(str) {
      const parts = str.split(',');
      return parts.length > 1 ? parts[1].trim() : '';
    }
    
    // Update school dropdown options.
    function updateSchoolStateButtons() {
      const container = document.getElementById("schoolStateButtons");
      container.innerHTML = "";
      let base = athletes;
      if (currentSportFilter !== "All") {
        base = base.filter(a => a.sport === currentSportFilter);
      }
      if (currentHometownStateFilters.length > 0) {
        base = base.filter(a => currentHometownStateFilters.includes(getState(a.hometown)));
      }
      const stateSet = new Set();
      base.forEach(athlete => {
        const state = getState(athlete.school);
        if (state) stateSet.add(state);
      });
      stateSet.forEach(state => {
        const btn = document.createElement("button");
        btn.textContent = state;
        if (currentSchoolStateFilters.includes(state)) btn.classList.add("active");
        btn.onclick = function(e) {
          e.stopPropagation();
          if (currentSchoolStateFilters.includes(state)) {
            currentSchoolStateFilters = currentSchoolStateFilters.filter(s => s !== state);
            btn.classList.remove("active");
          } else {
            currentSchoolStateFilters.push(state);
            btn.classList.add("active");
          }
          populateTable();
          hideDropdown();
        };
        container.appendChild(btn);
      });
    }
    
    // Update hometown dropdown options.
    function updateHometownStateButtons() {
      const container = document.getElementById("hometownStateButtons");
      container.innerHTML = "";
      let base = athletes;
      if (currentSportFilter !== "All") {
        base = base.filter(a => a.sport === currentSportFilter);
      }
      if (currentSchoolStateFilters.length > 0) {
        base = base.filter(a => currentSchoolStateFilters.includes(getState(a.school)));
      }
      const stateSet = new Set();
      base.forEach(athlete => {
        const state = getState(athlete.hometown);
        if (state) stateSet.add(state);
      });
      stateSet.forEach(state => {
        const btn = document.createElement("button");
        btn.textContent = state;
        if (currentHometownStateFilters.includes(state)) btn.classList.add("active");
        btn.onclick = function(e) {
          e.stopPropagation();
          if (currentHometownStateFilters.includes(state)) {
            currentHometownStateFilters = currentHometownStateFilters.filter(s => s !== state);
            btn.classList.remove("active");
          } else {
            currentHometownStateFilters.push(state);
            btn.classList.add("active");
          }
          populateTable();
          hideDropdown();
        };
        container.appendChild(btn);
      });
    }
    
    function updateActiveStates() {
      document.querySelectorAll('#sportHeader .sort-menu button').forEach(b => {
        if (b.textContent.trim() === currentSportFilter) {
          b.classList.add("active");
        } else {
          b.classList.remove("active");
        }
      });
    }
    
    // Filter table by sport.
    function filterTableBySport(sport, btnElement) {
      const buttons = btnElement.parentElement.querySelectorAll("button");
      buttons.forEach(b => b.classList.remove("active"));
      btnElement.classList.add("active");
      currentSportFilter = sport;
      populateTable();
      hideDropdown();
    }
    
    // Populate table.
    function populateTable() {
      const tableBody = document.getElementById("athleteTable");
      tableBody.innerHTML = "";
      let filteredAthletes = athletes;
      if (currentSportFilter !== "All") {
        filteredAthletes = filteredAthletes.filter(a => a.sport === currentSportFilter);
      }
      if (currentSchoolStateFilters.length > 0) {
        filteredAthletes = filteredAthletes.filter(a => currentSchoolStateFilters.includes(getState(a.school)));
      }
      if (currentHometownStateFilters.length > 0) {
        filteredAthletes = filteredAthletes.filter(a => currentHometownStateFilters.includes(getState(a.hometown)));
      }
      filteredAthletes.forEach(athlete => {
        const row = tableBody.insertRow();
        const isolateCell = row.insertCell();
        isolateCell.className = "isolate-cell";
        const isolateBtn = document.createElement("button");
        isolateBtn.textContent = "Isolate";
        isolateBtn.className = "isolate-button";
        isolateBtn.onclick = function() {
          if (this.classList.contains("selected")) {
            this.classList.remove("selected");
            resetMap();
          } else {
            document.querySelectorAll(".isolate-button").forEach(b => b.classList.remove("selected"));
            this.classList.add("selected");
            gAll.selectAll(".line, .dot").remove();
            drawSingleAthlete(athlete);
          }
        };
        isolateCell.appendChild(isolateBtn);
        row.insertCell().textContent = athlete.name;
        row.insertCell().textContent = athlete.hometown;
        row.insertCell().textContent = athlete.school;
        row.insertCell().textContent = athlete.sport;
      });
      updateActiveStates();
      updateSchoolStateButtons();
      updateHometownStateButtons();
    }
    
    // Sorting functions.
    function sortTableButton(category, order, btnElement) {
      btnElement.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btnElement.classList.add('active');
      
      document.querySelectorAll("thead th").forEach(th => th.classList.remove("active-sort"));
      const parentTh = btnElement.closest("th");
      if (parentTh) {
        parentTh.classList.add("active-sort");
      }
      
      sortTable(category, order);
      hideDropdown();
    }
    function sortTable(category, order) {
      let sorted = [...athletes];
      if (category === 'name') {
        sorted.sort((a, b) => order === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
        currentSort["name"] = order;
      } else if (category === 'hometown') {
        sorted.sort((a, b) => order === 'asc' ? a.hometown.localeCompare(b.hometown) : b.hometown.localeCompare(a.hometown));
        currentSort["hometown"] = order;
      } else if (category === 'hometown_state') {
        sorted.sort((a, b) => {
          const stateA = getState(a.hometown), stateB = getState(b.hometown);
          return order === 'asc' ? stateA.localeCompare(stateB) : stateB.localeCompare(stateA);
        });
        currentSort["hometown"] = order === 'asc' ? 'state_asc' : 'state_desc';
      } else if (category === 'school') {
        sorted.sort((a, b) => order === 'asc' ? a.school.localeCompare(b.school) : b.school.localeCompare(a.school));
        currentSort["school"] = order;
      } else if (category === 'school_state') {
        sorted.sort((a, b) => {
          const stateA = getState(a.school), stateB = getState(b.school);
          return order === 'asc' ? stateA.localeCompare(stateB) : stateB.localeCompare(stateA);
        });
        currentSort["school"] = order === 'asc' ? 'state_asc' : 'state_desc';
      } else if (category === 'sport') {
        sorted.sort((a, b) => order === 'asc' ? a.sport.localeCompare(b.sport) : b.sport.localeCompare(a.sport));
        currentSort["sport"] = order;
      }
      athletes.length = 0;
      athletes.push(...sorted);
      populateTable();
    }
    
    // Dropdown toggle.
    document.querySelectorAll("thead th").forEach(th => {
      th.addEventListener("click", function(e) {
        if (e.target.tagName.toLowerCase() === "button") return;
        const menu = th.querySelector(".sort-menu");
        if (menu) {
          if (currentDropdown === menu && menu.style.display === "block") {
            hideDropdown();
          } else {
            hideDropdown();
            showDropdown(th);
          }
        }
        e.stopPropagation();
      });
    });
    document.addEventListener("click", () => { hideDropdown(); });
    
    async function drawSingleAthlete(athlete) {
      let hometownCoords = athlete.hometownCoords;
      let schoolCoords = athlete.schoolCoords;
      if (!hometownCoords) {
        hometownCoords = await getCoordinates(athlete.hometown);
      }
      if (!schoolCoords) {
        schoolCoords = await getCoordinates(athlete.school);
      }
      if (hometownCoords && schoolCoords) {
        if (!loadingBarHidden) {
          document.getElementById("loadingBar").style.display = "none";
          loadingBarHidden = true;
        }
        drawCurvedLine(hometownCoords, schoolCoords);
        addDots(hometownCoords, schoolCoords);
      }
    }
    
    function drawCurvedLine(hometown, school) {
      const midpoint = [(hometown[0] + school[0]) / 2, (hometown[1] + school[1]) / 2 + 5];
      const lineData = [hometown, midpoint, school].map(d => projection(d));
      let line = gAll.append("path")
        .datum(lineData)
        .attr("class", "line")
        .attr("d", d3.line().curve(d3.curveBasis))
        .attr("stroke-dasharray", function() { return this.getTotalLength(); })
        .attr("stroke-dashoffset", function() { return this.getTotalLength(); });
      if (animationEnabled) {
        line.transition().duration(2000).ease(d3.easeLinear).attr("stroke-dashoffset", 0);
      } else {
        line.attr("stroke-dashoffset", 0);
      }
    }
    
    function addDots(hometown, school) {
      gAll.append("circle")
        .attr("class", "dot")
        .attr("cx", projection(hometown)[0])
        .attr("cy", projection(hometown)[1])
        .attr("r", 3);
      gAll.append("circle")
        .attr("class", "dot")
        .attr("cx", projection(school)[0])
        .attr("cy", projection(school)[1])
        .attr("r", 3);
    }
    
    // Animation Control.
    const animationControlButton = document.getElementById("animationControlButton");
    animationControlButton.addEventListener("click", function() {
      animationEnabled = !animationEnabled;
      this.textContent = animationEnabled ? "Animation: On" : "Animation: Off";
    });
    
    function resetMap() {
      gAll.selectAll(".line, .dot").remove();
      loadingBarHidden = false;
      document.getElementById("loadingBar").style.display = "flex";
      drawLines();
    }
    
    const resetButton = document.getElementById("resetButton");
    resetButton.addEventListener("click", resetMap);
    
    function resetSorting() {
      for (let i = athletes.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [athletes[i], athletes[j]] = [athletes[j], athletes[i]];
      }
      currentSort = {};
      currentSchoolStateFilters = [];
      currentHometownStateFilters = [];
      currentSportFilter = "All";
      document.querySelectorAll('.sort-menu button').forEach(btn => btn.classList.remove('active'));
      populateTable();
      resetMap();
    }
    document.getElementById("resetSortingButton").addEventListener("click", resetSorting);
    
    async function drawLines() {
      if (!animationEnabled) {
        const results = await Promise.all(athletes.map(async athlete => {
          let hometownCoords = athlete.hometownCoords;
          let schoolCoords = athlete.schoolCoords;
          if (!hometownCoords) hometownCoords = await getCoordinates(athlete.hometown);
          if (!schoolCoords) schoolCoords = await getCoordinates(athlete.school);
          return { athlete, hometownCoords, schoolCoords };
        }));
        document.getElementById("loadingBar").style.display = "none";
        loadingBarHidden = true;
        requestAnimationFrame(() => {
          results.forEach(result => {
            if (result.hometownCoords && result.schoolCoords) {
              drawCurvedLine(result.hometownCoords, result.schoolCoords);
              addDots(result.hometownCoords, result.schoolCoords);
            }
          });
        });
      } else {
        await Promise.all(athletes.map(athlete => drawSingleAthlete(athlete)));
        document.getElementById("loadingBar").style.display = "none";
        loadingBarHidden = true;
      }
    }
    
    // Initial population.
    drawLines();
    updateSchoolStateButtons();
    updateHometownStateButtons();
    populateTable();
    
    // Zoom/Pan Functionality.
    const zoomBehavior = d3.zoom()
      .scaleExtent([0.5, 5])
      .on("zoom", (event) => {
        gAll.attr("transform", event.transform);
      });
    svg.call(zoomBehavior);
    
    document.getElementById("zoomIn").addEventListener("click", () => {
      svg.transition().duration(300).call(zoomBehavior.scaleBy, 1.2);
    });
    document.getElementById("zoomOut").addEventListener("click", () => {
      svg.transition().duration(300).call(zoomBehavior.scaleBy, 0.8);
    });
    document.getElementById("resetZoom").addEventListener("click", () => {
      svg.transition().duration(300).call(zoomBehavior.transform, d3.zoomIdentity);
    });
  </script>
</body>
</html>
